# confluence-dl v0.1.0 Implementation Plan

## Executive Summary

This document outlines the missing functionality for the v0.1.0 release of confluence-dl and provides a detailed implementation plan. The v0.1.0 release will focus on delivering core functionality: downloading Confluence pages with their child pages and embedded images.

## Current Implementation Status

### ‚úÖ What's Working (Production Ready)

#### Core Infrastructure

- **CLI Argument Parsing**: Complete with all flags defined using clap
- **Color Scheme System**: Semantic color methods for terminal output
- **Build System**: Git hash, timestamp, and target embedding
- **Authentication**: Multi-source credential loading (CLI flags ‚Üí env vars ‚Üí .netrc)
- **Testing Infrastructure**: cargo-nextest, insta snapshots, fake client pattern

#### Implemented Features

1. **Single Page Download**: Download a page by URL or ID to Markdown ‚úÖ
2. **Markdown Conversion**: Comprehensive storage format to Markdown converter ‚úÖ
   - Headings, paragraphs, formatting, lists, links, tables
   - Confluence macros (toc, panel, status, expand, anchor)
   - Task lists, images, code blocks, HTML entity decoding
3. **Image Download**: Extract, download, and link images locally ‚úÖ
   - Extract image references from `<ac:image>` and `<ri:attachment>` tags
   - Download images via Confluence attachments API
   - Save to configurable images directory with sanitized filenames
   - Update markdown links to reference local files
   - Skip existing files when `--overwrite` is not set
4. **Version Command**: Display version with build metadata (JSON/text) ‚úÖ
5. **Completions Command**: Generate shell completions for bash/zsh/fish/powershell/elvish ‚úÖ
6. **Auth Show Command**: Display authentication configuration with sources ‚úÖ

#### Partial Implementations

- **Auth Test Command**: Shows config but doesn't actually test API ‚ö†Ô∏è

### üöß What's Missing for v0.1.0

## Missing Functionality Analysis

### 1. Child Pages Download ‚úÖ **COMPLETED**

**Implementation Status**: Fully implemented in [`src/confluence.rs`](src/confluence.rs:1) and [`src/main.rs`](src/main.rs:1)

**Implemented Components**:

```rust
// In src/confluence.rs
impl ConfluenceApi for ConfluenceClient {
  // NEW METHOD
  fn get_child_pages(&self, page_id: &str) -> Result<Vec<Page>>;

  // NEW METHOD
  fn get_page_tree(&self, page_id: &str, max_depth: Option<usize>) -> Result<PageTree>;
}

// NEW STRUCT
pub struct PageTree {
  pub page: Page,
  pub children: Vec<PageTree>,
  pub depth: usize,
}
```

**API Endpoint**: `GET /wiki/rest/api/content/{id}/child/page`

**Implementation Tasks**: ‚úÖ All Complete

- [x] Add `get_child_pages()` method to [`ConfluenceApi`](src/confluence.rs:14) trait
- [x] Add [`PageTree`](src/confluence.rs:138) struct for hierarchical representation
- [x] Add [`ChildPagesResponse`](src/confluence.rs:133) for API response deserialization
- [x] Implement [`get_child_pages()`](src/confluence.rs:202) in [`ConfluenceClient`](src/confluence.rs:177)
- [x] Implement [`get_page_tree()`](src/confluence.rs:351) with recursive traversal and depth limiting
- [x] Handle circular references with visited page tracking ([`get_page_tree_recursive()`](src/confluence.rs:368))
- [x] Create hierarchical directory structure in [`download_page_tree()`](src/main.rs:338)
- [x] Update [`download_page()`](src/main.rs:420) to handle children when `--children` flag is set
- [x] Add progress indication showing page count and depth
- [x] Write comprehensive integration tests in [`tests/e2e_tests.rs`](tests/e2e_tests.rs:301)
- [x] Add test fixtures for child pages ([`tests/common/fixtures.rs`](tests/common/fixtures.rs:224))
- [x] Implement in [`FakeConfluenceClient`](tests/common/fake_confluence.rs:17)

**Edge Cases Handled**:

- ‚úÖ Circular references (A ‚Üí B ‚Üí A) - Detected and skipped with warning
- ‚úÖ Depth limiting with `--max-depth` flag
- ‚úÖ Hierarchical directory creation (e.g., `output/Parent Page/Child Page.md`)
- ‚úÖ File overwrite protection with `--overwrite` flag
- ‚úÖ Image downloading works for entire page trees

**Features**:

1. **Recursive Tree Traversal**: [`get_page_tree()`](src/confluence.rs:351) builds complete page hierarchy
2. **Depth Limiting**: Optional `max_depth` parameter respects `--max-depth` CLI flag
3. **Circular Reference Detection**: Tracks visited pages to prevent infinite loops
4. **Hierarchical Output**: Creates nested directory structure matching page hierarchy
5. **Progress Feedback**: Shows total page count and individual page titles during download
6. **Image Support**: Downloads images for all pages in the tree

---

### 2. Image Download ‚úÖ **COMPLETED**

**Implementation Status**: Fully implemented in [`src/images.rs`](src/images.rs:1)

**Implemented Components**:

1. **Image Reference Extraction** ([`extract_image_references()`](src/images.rs:28))
   - Parses Confluence storage format to find `<ac:image>` tags
   - Extracts `ri:filename` attributes and alt text
   - Returns structured `ImageReference` objects

2. **Image Downloading** ([`download_images()`](src/images.rs:63))
   - Fetches page attachments via [`get_attachments()`](src/confluence.rs:21)
   - Downloads images using [`download_attachment()`](src/confluence.rs:24)
   - Saves to configurable images directory
   - Sanitizes filenames for filesystem safety
   - Skips existing files when `--overwrite` is false
   - Returns filename mapping for link updates

3. **Markdown Link Updates** ([`update_markdown_image_links()`](src/images.rs:130))
   - Replaces Confluence image URLs with local file paths
   - Uses relative paths for portability
   - Handles cross-platform path separators

4. **Integration in Main Flow** ([`download_page()`](src/main.rs:408-445))
   - Extracts images from storage content before markdown conversion
   - Downloads images when `--download-images` flag is set
   - Updates markdown with local image paths
   - Provides progress feedback with colored output

**Testing Coverage**:
- ‚úÖ Unit tests for image extraction ([`tests/images.rs`](src/images.rs:173))
- ‚úÖ Unit tests for filename sanitization
- ‚úÖ Unit tests for markdown link updates
- ‚úÖ Integration with [`FakeConfluenceClient`](tests/common/fake_confluence.rs:17) in E2E tests

**CLI Flags**:
- `--download-images` - Enable image downloading
- `--images-dir <DIR>` - Specify images subdirectory (default: "images")
- `--overwrite` - Overwrite existing image files

**Supported Image Sources**:
- ‚úÖ Confluence attachments via `<ri:attachment ri:filename="..."/>`
- ‚ùå External URLs (deferred to v0.2.0 - currently kept as-is)

---

### 3. Authentication Testing ‚úÖ **COMPLETED**

**Implementation Status**: Fully implemented in [`src/main.rs`](src/main.rs:56) and [`src/confluence.rs`](src/confluence.rs:310)

**Implemented Components**:

```rust
// In src/confluence.rs
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UserInfo {
  #[serde(rename = "accountId")]
  pub account_id: String,
  pub email: Option<String>,
  #[serde(rename = "displayName")]
  pub display_name: String,
  #[serde(rename = "publicName")]
  pub public_name: Option<String>,
}

impl ConfluenceApi for ConfluenceClient {
  fn test_auth(&self) -> Result<UserInfo> {
    // Calls GET /wiki/rest/api/user/current
    // Returns UserInfo with account details
  }
}
```

**API Endpoint**: `GET /wiki/rest/api/user/current`

**Implementation Tasks**: ‚úÖ All Complete

- [x] Modify [`test_auth()`](src/confluence.rs:310) to return user information
- [x] Create [`UserInfo`](src/confluence.rs:137) struct for response deserialization
- [x] Update [`handle_auth_command()`](src/main.rs:56) to call API and display results
- [x] Add helpful error messages for common auth failures (invalid token, wrong URL, etc.)
- [x] Write integration tests ([`tests/e2e_tests.rs`](tests/e2e_tests.rs:113))

**Features**:

1. **Credential Loading**: Automatically loads credentials from CLI flags, environment variables, or .netrc
2. **User Information Display**: Shows account ID, display name, email, and public name
3. **Helpful Error Messages**: Provides specific guidance for common auth failures:
   - Invalid API token with link to token management
   - Incorrect username format
   - Wrong base URL format
   - Network connectivity issues
4. **Exit Codes**: Uses proper exit codes (0 for success, 1 for general errors, 2 for auth failures)
5. **Colored Output**: Uses semantic color scheme for success/error messages

**Testing Coverage**:
- ‚úÖ Unit tests for successful authentication ([`tests/e2e_tests.rs`](tests/e2e_tests.rs:113))
- ‚úÖ Unit tests for authentication failures ([`tests/e2e_tests.rs`](tests/e2e_tests.rs:122))
- ‚úÖ [`FakeConfluenceClient`](tests/common/fake_confluence.rs:119) implementation for testing

---

### 4. Progress Indication (MEDIUM PRIORITY) üü°

**Current State**: Basic text output, no progress bars

**Required Implementation**:

Add `indicatif` dependency to `Cargo.toml`:

```toml
[dependencies]
indicatif = "0.17"
```

```rust
use indicatif::{ProgressBar, ProgressStyle};

fn download_page_tree(client: &dyn ConfluenceApi, root_id: &str, colors: &ColorScheme) {
  let pb = ProgressBar::new_spinner();
  pb.set_style(
    ProgressStyle::default_spinner()
      .template("{spinner:.green} [{elapsed_precise}] {msg}")
      .unwrap()
  );

  pb.set_message("Discovering pages...");
  // ... discover page tree

  pb.finish_with_message(format!("Found {} pages", total));

  // Download with progress bar
  let pb = ProgressBar::new(total as u64);
  for page in pages {
    pb.set_message(format!("Downloading: {}", page.title));
    // ... download
    pb.inc(1);
  }
  pb.finish_with_message("Complete!");
}
```

**Implementation Tasks**:

- [ ] Add indicatif dependency
- [ ] Create progress bar for multi-page downloads
- [ ] Show spinner during API calls
- [ ] Display current page title and count (e.g., "5/23")
- [ ] Respect `--quiet` flag (disable progress bars)
- [ ] Respect `--verbose` flag (show more details)

**Estimated Complexity**: Low (1-2 hours)

---

### 5. Enhanced Error Handling (MEDIUM PRIORITY) üü°

**Current State**: Basic error messages, generic exit codes

**Required Improvements**:

```rust
// In src/main.rs
fn main() {
  // ... existing code

  if let Err(e) = result {
    let exit_code = match e.downcast_ref::<ConfluenceError>() {
      Some(ConfluenceError::AuthenticationFailed) => 2,
      Some(ConfluenceError::NetworkError(_)) => 3,
      Some(ConfluenceError::PermissionDenied) => 5,
      _ => 1,
    };

    eprintln!("{} {}", colors.error("Error:"), e);

    // Add helpful suggestions
    if exit_code == 2 {
      eprintln!("\n{}", colors.info("Suggestions:"));
      eprintln!("  1. Check your API token at https://id.atlassian.com/manage-profile/security/api-tokens");
      eprintln!("  2. Verify credentials with: confluence-dl auth test");
    }

    process::exit(exit_code);
  }
}
```

**Implementation Tasks**:

- [ ] Create custom error types with proper context
- [ ] Implement proper exit codes (as defined in [CLI_DESIGN.md](CLI_DESIGN.md:360))
- [ ] Add helpful suggestions for common errors
- [ ] Improve error messages with actionable guidance
- [ ] Add retry logic for transient network failures
- [ ] Write tests for error scenarios

**Estimated Complexity**: Low-Medium (2 hours)

---

## Features to Defer to v0.2.0+

### Attachments Download (--attachments)

**Reason**: Lower priority than images; similar implementation pattern can be reused
**Complexity**: Medium (2-3 hours)

### Link Conversion (--convert-links)

**Reason**: Complex cross-reference resolution; basic links already work
**Complexity**: High (4-6 hours)

### Rate Limiting (--rate-limit)

**Reason**: Not critical for typical usage; easy to add later
**Complexity**: Low (1 hour)

### Parallel Downloads (--parallel)

**Reason**: Performance optimization; single-threaded works fine for v0.1.0
**Complexity**: Medium (3-4 hours)

### Alternative Output Formats (--format json/html)

**Reason**: Markdown is the primary use case
**Complexity**: Medium per format (2-3 hours each)

---

## Recommended v0.1.0 Scope

### üéØ Must-Have Features (MVP)

1. **Single Page Download** ‚úÖ (Completed)
2. **Image Download** ‚úÖ (Completed)
3. **Child Pages Download** ‚úÖ (Completed)
4. **Authentication Testing** ‚úÖ (Completed)

### üåü Nice-to-Have Features

5. **Progress Indication** üü° (Enhances UX)
6. **Enhanced Error Handling** üü° (Professional polish)

### Total Estimated Effort

- ~~Must-have features: 7-9 hours~~ **ALL COMPLETED! ‚úÖ**
  - ‚úÖ Image Download: 2-3 hours (COMPLETED)
  - ‚úÖ Child Pages Download: 3-4 hours (COMPLETED)
  - ‚úÖ Authentication Testing: 1 hour (COMPLETED)
- Nice-to-have features: **3-4 hours (optional)**
- **Total Remaining: 0 hours for MVP, 3-4 hours for polish features**

---

## Implementation Order

### Phase 1: Core Download Features ‚úÖ **ALL COMPLETED**

1. ~~Child pages download (3-4 hours)~~ ‚úÖ **COMPLETED**
   - ‚úÖ Add API method
   - ‚úÖ Implement tree traversal
   - ‚úÖ Create directory structure
   - ‚úÖ Add tests
2. ~~Image download (2-3 hours)~~ ‚úÖ **COMPLETED**
   - ‚úÖ Parse image URLs
   - ‚úÖ Download images
   - ‚úÖ Update markdown links
   - ‚úÖ Add tests
3. ~~Complete auth testing (1 hour)~~ ‚úÖ **COMPLETED**
   - ‚úÖ Return user info from API
   - ‚úÖ Display results with helpful error messages
   - ‚úÖ Add integration tests

### Phase 2: Polish & UX (3-4 hours)

4. Progress indication (1-2 hours)
5. Enhanced error handling (2 hours)

### Phase 3: Testing & Documentation (2-3 hours)

6. End-to-end integration tests
7. Update README with v0.1.0 features
8. Create release notes
9. Test on real Confluence instances

---

## Testing Strategy

### Unit Tests

- API client methods ([`src/confluence.rs`](src/confluence.rs:242))
- Image URL extraction and link updating
- Directory structure creation
- Error handling paths

### Integration Tests

- Full page download workflow ([`tests/e2e_tests.rs`](tests/e2e_tests.rs:1))
- Child page traversal with [`FakeConfluenceClient`](tests/common/fake_confluence.rs:17)
- Image download with mocked responses
- Authentication scenarios

### Manual Testing Checklist

- [ ] Download single page from Confluence Cloud
- [ ] Download page with children (depth 1-3)
- [ ] Download page with images
- [ ] Test authentication with .netrc
- [ ] Test authentication with env vars
- [ ] Test authentication with CLI flags
- [ ] Test error scenarios (auth failure, network timeout, invalid URL)
- [ ] Test --dry-run mode
- [ ] Test --overwrite behavior
- [ ] Test progress bars with --verbose and --quiet

---

## Success Criteria for v0.1.0

### Functional Requirements

- [x] Download a single Confluence page to Markdown
- [x] Download and embed images locally
- [x] Download page hierarchies with --children flag
- [x] Test authentication with auth test command
- [ ] Show progress for multi-page downloads (nice-to-have)
- [x] Handle errors gracefully with helpful messages (auth errors complete)

### Quality Requirements ‚úÖ

- [ ] All new code covered by tests (>80% coverage)
- [ ] No clippy warnings
- [ ] All tests pass with `cargo nextest run`
- [ ] Documentation updated
- [ ] Release notes written

### User Experience ‚úÖ

- [ ] Clear progress indication for long operations
- [ ] Helpful error messages with actionable suggestions
- [ ] Works on Linux and macOS
- [ ] Easy installation via GitHub releases

---

## Open Questions for Discussion

1. **Directory Structure**: How should we organize downloaded child pages?

   - Option A: Flat structure with page IDs: `output/123456-Page-Title.md`
   - Option B: Hierarchical: `output/Parent/Child/Grandchild.md`
   - **Recommendation**: Option B (hierarchical) preserves structure

2. **Image Naming**: How should we name downloaded images?

   - Option A: Original filename: `image.png` (risk of conflicts)
   - Option B: Hash-based: `a1b2c3d4.png` (unique but opaque)
   - Option C: Hybrid: `page-title_image.png` (descriptive and unique)
   - **Recommendation**: Option C

3. **External Images**: Should we download external URLs (not Confluence attachments)?

   - Option A: Yes, download everything
   - Option B: No, keep external URLs as-is
   - Option C: Make it configurable
   - **Recommendation**: Option B for v0.1.0 (simplest), Option C for v0.2.0

4. **Rate Limiting**: Should we implement rate limiting in v0.1.0?
   - **Recommendation**: No, defer to v0.2.0 unless real-world testing shows it's needed

---

## Next Steps

1. **Review this plan** with stakeholders
2. **Prioritize features** if timeline is tight
3. **Create GitHub issues** for each implementation task
4. **Set up project board** to track progress
5. **Begin implementation** following the phased approach

---

## Appendix: API Endpoints Reference

### Currently Used ‚úÖ

- `GET /wiki/rest/api/content/{id}?expand=body.storage,body.view,space` - Get page
- `GET /wiki/rest/api/user/current` - Test auth (partial)

### Needed for v0.1.0

- `GET /wiki/rest/api/content/{id}/child/page` - Get child pages üî¥
- `GET /wiki/rest/api/content/{id}/child/attachment` - Get attachments ‚úÖ
- `GET /wiki/download/attachments/{pageId}/{filename}` - Download attachment ‚úÖ

### Reference Documentation

- [Confluence REST API](https://developer.atlassian.com/cloud/confluence/rest/v1/intro/)
- [Content API](https://developer.atlassian.com/cloud/confluence/rest/v1/api-group-content/)
- [Authentication](https://developer.atlassian.com/cloud/confluence/basic-auth-for-rest-apis/)
