# confluence-dl v0.1.0 Implementation Plan

## Executive Summary

This document outlines the missing functionality for the v0.1.0 release of confluence-dl and provides a detailed implementation plan. The v0.1.0 release will focus on delivering core functionality: downloading Confluence pages with their child pages and embedded images.

## Current Implementation Status

### âœ… What's Working (Production Ready)

#### Core Infrastructure

- **CLI Argument Parsing**: Complete with all flags defined using clap
- **Color Scheme System**: Semantic color methods for terminal output
- **Build System**: Git hash, timestamp, and target embedding
- **Authentication**: Multi-source credential loading (CLI flags â†’ env vars â†’ .netrc)
- **Testing Infrastructure**: cargo-nextest, insta snapshots, fake client pattern

#### Implemented Features

1. **Single Page Download**: Download a page by URL or ID to Markdown âœ…
2. **Markdown Conversion**: Comprehensive storage format to Markdown converter âœ…
   - Headings, paragraphs, formatting, lists, links, tables
   - Confluence macros (toc, panel, status, expand, anchor)
   - Task lists, images, code blocks, HTML entity decoding
3. **Version Command**: Display version with build metadata (JSON/text) âœ…
4. **Completions Command**: Generate shell completions for bash/zsh/fish/powershell/elvish âœ…
5. **Auth Show Command**: Display authentication configuration with sources âœ…

#### Partial Implementations

- **Auth Test Command**: Shows config but doesn't actually test API âš ï¸
- **Markdown Image References**: Converts image tags but doesn't download âš ï¸

### ðŸš§ What's Missing for v0.1.0

## Missing Functionality Analysis

### 1. Child Pages Download (HIGH PRIORITY) ðŸ”´

**Current State**: `--children` and `--max-depth` flags exist but not implemented

**Required Implementation**:

```rust
// In src/confluence.rs
impl ConfluenceApi for ConfluenceClient {
  // NEW METHOD
  fn get_child_pages(&self, page_id: &str) -> Result<Vec<Page>>;

  // NEW METHOD
  fn get_page_tree(&self, page_id: &str, max_depth: Option<usize>) -> Result<PageTree>;
}

// NEW STRUCT
pub struct PageTree {
  pub page: Page,
  pub children: Vec<PageTree>,
  pub depth: usize,
}
```

**API Endpoint**: `GET /wiki/rest/api/content/{id}/child/page`

**Implementation Tasks**:

- [ ] Add `get_child_pages()` method to [`ConfluenceApi`](src/confluence.rs:14) trait
- [ ] Implement recursive tree traversal with depth limiting
- [ ] Handle circular references (track visited pages)
- [ ] Create hierarchical directory structure (e.g., `output/Parent Page/Child Page.md`)
- [ ] Update [`download_page()`](src/main.rs:338) to handle children
- [ ] Add progress indication for multi-page downloads
- [ ] Write integration tests using [`FakeConfluenceClient`](tests/common/fake_confluence.rs:17)

**Edge Cases**:

- Circular references (A â†’ B â†’ A)
- Very deep hierarchies (>10 levels)
- Large page counts (>100 children)
- Permission denied on child pages

**Estimated Complexity**: Medium-High (3-4 hours)

---

### 2. Image Download (HIGH PRIORITY) ðŸ”´

**Current State**: `--download-images` and `--images-dir` flags exist; markdown converter creates image links but doesn't download

**Required Implementation**:

```rust
// In src/confluence.rs
impl ConfluenceApi for ConfluenceClient {
  // NEW METHOD
  fn download_attachment(&self, url: &str, output_path: &Path) -> Result<()>;
}

// In src/main.rs or new src/images.rs
pub struct ImageDownloader {
  client: Arc<dyn ConfluenceApi>,
  output_dir: PathBuf,
}

impl ImageDownloader {
  fn extract_image_urls(markdown: &str) -> Vec<String>;
  fn download_images(&self, urls: Vec<String>) -> Result<HashMap<String, String>>;
  fn update_markdown_links(&self, markdown: &str, url_map: HashMap<String, String>) -> String;
}
```

**Implementation Tasks**:

- [ ] Parse image URLs from Confluence storage content (before markdown conversion)
- [ ] Extract image attachment IDs from `<ac:image>` and `<ri:attachment>` tags
- [ ] Download images using Confluence API: `GET /wiki/rest/api/content/{pageId}/child/attachment`
- [ ] Save images to `{output_dir}/{images_dir}/` with sanitized filenames
- [ ] Update markdown image links to reference local files (relative paths)
- [ ] Handle external image URLs (download or keep as-is based on config)
- [ ] Add file existence checks (skip if already downloaded and `--overwrite` not set)
- [ ] Write tests for image extraction and link updating

**Image Sources in Confluence**:

1. **Attachments**: `<ri:attachment ri:filename="image.png" />`
2. **External URLs**: `<ri:url ri:value="https://example.com/image.png" />`
3. **Embedded**: `<ac:image><ri:attachment>...</ri:attachment></ac:image>`

**Estimated Complexity**: Medium (2-3 hours)

---

### 3. Authentication Testing (MEDIUM PRIORITY) ðŸŸ¡

**Current State**: [`auth test`](src/main.rs:58) command displays config but doesn't call API

**Required Implementation**:

```rust
// In src/main.rs
fn handle_auth_command(subcommand: &AuthCommand, cli: &Cli, colors: &ColorScheme) {
  match subcommand {
    AuthCommand::Test => {
      // Load credentials
      let (username, token) = load_credentials(&cli.auth.url.unwrap(), cli)?;

      // Create client and test
      let client = ConfluenceClient::new(...)?;
      match client.test_auth() {
        Ok(user_info) => {
          // Display success with user info
        }
        Err(e) => {
          // Display failure with helpful suggestions
        }
      }
    }
  }
}
```

**API Endpoint**: `GET /wiki/rest/api/user/current`

**Response Structure**:

```json
{
  "accountId": "557058:abc123...",
  "email": "user@example.com",
  "displayName": "John Doe",
  "publicName": "John Doe"
}
```

**Implementation Tasks**:

- [ ] Modify [`test_auth()`](src/confluence.rs:169) to return user information
- [ ] Create `UserInfo` struct for response deserialization
- [ ] Update [`handle_auth_command()`](src/main.rs:56) to call API and display results
- [ ] Add helpful error messages for common auth failures (invalid token, wrong URL, etc.)
- [ ] Write integration test

**Estimated Complexity**: Low (1 hour)

---

### 4. Progress Indication (MEDIUM PRIORITY) ðŸŸ¡

**Current State**: Basic text output, no progress bars

**Required Implementation**:

Add `indicatif` dependency to `Cargo.toml`:

```toml
[dependencies]
indicatif = "0.17"
```

```rust
use indicatif::{ProgressBar, ProgressStyle};

fn download_page_tree(client: &dyn ConfluenceApi, root_id: &str, colors: &ColorScheme) {
  let pb = ProgressBar::new_spinner();
  pb.set_style(
    ProgressStyle::default_spinner()
      .template("{spinner:.green} [{elapsed_precise}] {msg}")
      .unwrap()
  );

  pb.set_message("Discovering pages...");
  // ... discover page tree

  pb.finish_with_message(format!("Found {} pages", total));

  // Download with progress bar
  let pb = ProgressBar::new(total as u64);
  for page in pages {
    pb.set_message(format!("Downloading: {}", page.title));
    // ... download
    pb.inc(1);
  }
  pb.finish_with_message("Complete!");
}
```

**Implementation Tasks**:

- [ ] Add indicatif dependency
- [ ] Create progress bar for multi-page downloads
- [ ] Show spinner during API calls
- [ ] Display current page title and count (e.g., "5/23")
- [ ] Respect `--quiet` flag (disable progress bars)
- [ ] Respect `--verbose` flag (show more details)

**Estimated Complexity**: Low (1-2 hours)

---

### 5. Enhanced Error Handling (MEDIUM PRIORITY) ðŸŸ¡

**Current State**: Basic error messages, generic exit codes

**Required Improvements**:

```rust
// In src/main.rs
fn main() {
  // ... existing code

  if let Err(e) = result {
    let exit_code = match e.downcast_ref::<ConfluenceError>() {
      Some(ConfluenceError::AuthenticationFailed) => 2,
      Some(ConfluenceError::NetworkError(_)) => 3,
      Some(ConfluenceError::PermissionDenied) => 5,
      _ => 1,
    };

    eprintln!("{} {}", colors.error("Error:"), e);

    // Add helpful suggestions
    if exit_code == 2 {
      eprintln!("\n{}", colors.info("Suggestions:"));
      eprintln!("  1. Check your API token at https://id.atlassian.com/manage-profile/security/api-tokens");
      eprintln!("  2. Verify credentials with: confluence-dl auth test");
    }

    process::exit(exit_code);
  }
}
```

**Implementation Tasks**:

- [ ] Create custom error types with proper context
- [ ] Implement proper exit codes (as defined in [CLI_DESIGN.md](CLI_DESIGN.md:360))
- [ ] Add helpful suggestions for common errors
- [ ] Improve error messages with actionable guidance
- [ ] Add retry logic for transient network failures
- [ ] Write tests for error scenarios

**Estimated Complexity**: Low-Medium (2 hours)

---

## Features to Defer to v0.2.0+

### Attachments Download (--attachments)

**Reason**: Lower priority than images; similar implementation pattern can be reused
**Complexity**: Medium (2-3 hours)

### Comments Integration (--comments)

**Reason**: Nice-to-have feature; requires separate API calls
**Complexity**: Medium (2-3 hours)

### Link Conversion (--convert-links)

**Reason**: Complex cross-reference resolution; basic links already work
**Complexity**: High (4-6 hours)

### Rate Limiting (--rate-limit)

**Reason**: Not critical for typical usage; easy to add later
**Complexity**: Low (1 hour)

### Parallel Downloads (--parallel)

**Reason**: Performance optimization; single-threaded works fine for v0.1.0
**Complexity**: Medium (3-4 hours)

### Alternative Output Formats (--format json/html)

**Reason**: Markdown is the primary use case
**Complexity**: Medium per format (2-3 hours each)

---

## Recommended v0.1.0 Scope

### ðŸŽ¯ Must-Have Features (MVP)

1. **Single Page Download** âœ… (Already working)
2. **Child Pages Download** ðŸ”´ (High priority)
3. **Image Download** ðŸ”´ (High priority)
4. **Authentication Testing** ðŸŸ¡ (Medium priority - complete implementation)

### ðŸŒŸ Nice-to-Have Features

5. **Progress Indication** ðŸŸ¡ (Enhances UX)
6. **Enhanced Error Handling** ðŸŸ¡ (Professional polish)

### Total Estimated Effort

- Must-have features: **7-9 hours**
- Nice-to-have features: **3-4 hours**
- **Total: 10-13 hours of development time**

---

## Implementation Order

### Phase 1: Core Download Features (6-8 hours)

1. Child pages download (3-4 hours)
   - Add API method
   - Implement tree traversal
   - Create directory structure
   - Add tests
2. Image download (2-3 hours)
   - Parse image URLs
   - Download images
   - Update markdown links
   - Add tests
3. Complete auth testing (1 hour)
   - Return user info from API
   - Display results
   - Add tests

### Phase 2: Polish & UX (3-4 hours)

4. Progress indication (1-2 hours)
5. Enhanced error handling (2 hours)

### Phase 3: Testing & Documentation (2-3 hours)

6. End-to-end integration tests
7. Update README with v0.1.0 features
8. Create release notes
9. Test on real Confluence instances

---

## Testing Strategy

### Unit Tests

- API client methods ([`src/confluence.rs`](src/confluence.rs:242))
- Image URL extraction and link updating
- Directory structure creation
- Error handling paths

### Integration Tests

- Full page download workflow ([`tests/e2e_tests.rs`](tests/e2e_tests.rs:1))
- Child page traversal with [`FakeConfluenceClient`](tests/common/fake_confluence.rs:17)
- Image download with mocked responses
- Authentication scenarios

### Manual Testing Checklist

- [ ] Download single page from Confluence Cloud
- [ ] Download page with children (depth 1-3)
- [ ] Download page with images
- [ ] Test authentication with .netrc
- [ ] Test authentication with env vars
- [ ] Test authentication with CLI flags
- [ ] Test error scenarios (auth failure, network timeout, invalid URL)
- [ ] Test --dry-run mode
- [ ] Test --overwrite behavior
- [ ] Test progress bars with --verbose and --quiet

---

## Success Criteria for v0.1.0

### Functional Requirements âœ…

- [x] Download a single Confluence page to Markdown
- [ ] Download page hierarchies with --children flag
- [ ] Download and embed images locally
- [ ] Test authentication with auth test command
- [ ] Show progress for multi-page downloads
- [ ] Handle errors gracefully with helpful messages

### Quality Requirements âœ…

- [ ] All new code covered by tests (>80% coverage)
- [ ] No clippy warnings
- [ ] All tests pass with `cargo nextest run`
- [ ] Documentation updated
- [ ] Release notes written

### User Experience âœ…

- [ ] Clear progress indication for long operations
- [ ] Helpful error messages with actionable suggestions
- [ ] Works on Linux and macOS
- [ ] Easy installation via GitHub releases

---

## Open Questions for Discussion

1. **Directory Structure**: How should we organize downloaded child pages?

   - Option A: Flat structure with page IDs: `output/123456-Page-Title.md`
   - Option B: Hierarchical: `output/Parent/Child/Grandchild.md`
   - **Recommendation**: Option B (hierarchical) preserves structure

2. **Image Naming**: How should we name downloaded images?

   - Option A: Original filename: `image.png` (risk of conflicts)
   - Option B: Hash-based: `a1b2c3d4.png` (unique but opaque)
   - Option C: Hybrid: `page-title_image.png` (descriptive and unique)
   - **Recommendation**: Option C

3. **External Images**: Should we download external URLs (not Confluence attachments)?

   - Option A: Yes, download everything
   - Option B: No, keep external URLs as-is
   - Option C: Make it configurable
   - **Recommendation**: Option B for v0.1.0 (simplest), Option C for v0.2.0

4. **Rate Limiting**: Should we implement rate limiting in v0.1.0?
   - **Recommendation**: No, defer to v0.2.0 unless real-world testing shows it's needed

---

## Next Steps

1. **Review this plan** with stakeholders
2. **Prioritize features** if timeline is tight
3. **Create GitHub issues** for each implementation task
4. **Set up project board** to track progress
5. **Begin implementation** following the phased approach

---

## Appendix: API Endpoints Reference

### Currently Used âœ…

- `GET /wiki/rest/api/content/{id}?expand=body.storage,body.view,space` - Get page
- `GET /wiki/rest/api/user/current` - Test auth (partial)

### Needed for v0.1.0 ðŸ”´

- `GET /wiki/rest/api/content/{id}/child/page` - Get child pages
- `GET /wiki/rest/api/content/{id}/child/attachment` - Get attachments
- `GET /wiki/download/attachments/{pageId}/{filename}` - Download attachment

### Reference Documentation

- [Confluence REST API](https://developer.atlassian.com/cloud/confluence/rest/v1/intro/)
- [Content API](https://developer.atlassian.com/cloud/confluence/rest/v1/api-group-content/)
- [Authentication](https://developer.atlassian.com/cloud/confluence/basic-auth-for-rest-apis/)
